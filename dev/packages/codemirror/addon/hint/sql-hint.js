(function(q){"object"==typeof exports&&"object"==typeof module?q(require("../../lib/codemirror"),require("../../mode/sql/sql")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../../mode/sql/sql"],q):q(CodeMirror)})(function(q){function x(b){return"[object Array]"==Object.prototype.toString.call(b)}function B(b,a){return b.getModeAt(b.getCursor()).config[a]||q.resolveMode("text/x-sql")[a]}function w(b){return"string"==typeof b?b:b.text}function C(b,a){x(a)&&(a={columns:a});a.text||
(a.text=b);return a}function I(b){var a={};if(x(b))for(var c=b.length-1;0<=c;c--){var d=b[c];a[w(d).toUpperCase()]=C(w(d),d)}else if(b)for(c in b)a[c.toUpperCase()]=C(c,b[c]);return a}function D(b){var a={},c;for(c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}function E(b,a){var c=b.length;a=w(a).substr(0,c);return b.toUpperCase()===a.toUpperCase()}function v(b,a,c,d){if(x(c))for(var e=0;e<c.length;e++)E(a,c[e])&&b.push(d(c[e]));else for(e in c)if(c.hasOwnProperty(e)){var f=c[e];f=f&&!0!==f?f.displayText?
{text:f.text,displayText:f.displayText}:f.text:e;E(a,f)&&b.push(d(f))}}function J(b){"."==b.charAt(0)&&(b=b.substr(1));b=b.split(l+l);for(var a=0;a<b.length;a++)b[a]=b[a].replace(new RegExp(l,"g"),"");return b.join(l)}function y(b){for(var a=w(b).split("."),c=0;c<a.length;c++)a[c]=l+a[c].replace(new RegExp(l,"g"),l+l)+l;a=a.join(".");if("string"==typeof b)return a;b=D(b);b.text=a;return b}function K(b,a,c,d){for(var e=!1,f=[],m=a.start,n=!0;n;)n="."==a.string.charAt(0),e=e||a.string.charAt(0)==l,
m=a.start,f.unshift(J(a.string)),a=d.getTokenAt(r(b.line,a.start)),"."==a.string&&(n=!0,a=d.getTokenAt(r(b.line,a.start)));b=f.join(".");v(c,b,t,function(h){return e?y(h):h});v(c,b,p,function(h){return e?y(h):h});b=f.pop();var k=f.join("."),g=!1,u=k;t[k.toUpperCase()]||(f=k,k=F(k,d),k!==f&&(g=!0));(d=t[k.toUpperCase()])&&d.columns&&(d=d.columns);d&&v(c,b,d,function(h){var z=k;1==g&&(z=u);"string"==typeof h?h=z+"."+h:(h=D(h),h.text=z+"."+h.text);return e?y(h):h});return m}function L(b,a){b=b.split(/\s+/);
for(var c=0;c<b.length;c++)b[c]&&a(b[c].replace(/[`,;]/g,""))}function F(b,a){var c=a.doc,d=c.getValue(),e=b.toUpperCase(),f="",m="";b=[];for(var n=r(0,0),k=r(a.lastLine(),a.getLineHandle(a.lastLine()).length),g=d.indexOf(A.QUERY_DIV);-1!=g;)b.push(c.posFromIndex(g)),g=d.indexOf(A.QUERY_DIV,g+1);b.unshift(r(0,0));b.push(r(a.lastLine(),a.getLineHandle(a.lastLine()).text.length));d=null;g=a.getCursor();for(a=0;a<b.length;a++){if((null==d||0<G(g,d))&&0>=G(g,b[a])){n=d;k=b[a];break}d=b[a]}if(n)for(c=
c.getRange(n,k,!1),a=0;a<c.length&&(L(c[a],function(u){var h=u.toUpperCase();h===e&&t[f.toUpperCase()]&&(m=f);h!==A.ALIAS_KEYWORD&&(f=u)}),!m);a++);return m}var t,p,H,l,A={QUERY_DIV:";",ALIAS_KEYWORD:"AS"},r=q.Pos,G=q.cmpPos;q.registerHelper("hint","sql",function(b,a){t=I(a&&a.tables);var c=a&&a.defaultTable;a=a&&a.disableKeywords;p=c&&t[c.toUpperCase()];H=B(b,"keywords")||[];l=B(b,"identifierQuote")||"`";c&&!p&&(p=F(c,b));p=p||[];p.columns&&(p=p.columns);c=b.getCursor();var d=[],e=b.getTokenAt(c);
e.end>c.ch&&(e.end=c.ch,e.string=e.string.slice(0,c.ch-e.start));if(e.string.match(/^[.`"'\w@][\w$#]*$/g)){var f=e.string;var m=e.start;var n=e.end}else m=n=c.ch,f="";if("."==f.charAt(0)||f.charAt(0)==l)m=K(c,e,d,b);else{var k=function(g,u){"object"===typeof g?g.className=u:g={text:g,className:u};return g};v(d,f,p,function(g){return k(g,"CodeMirror-hint-table CodeMirror-hint-default-table")});v(d,f,t,function(g){return k(g,"CodeMirror-hint-table")});a||v(d,f,H,function(g){return k(g.toUpperCase(),
"CodeMirror-hint-keyword")})}return{list:d,from:r(c.line,m),to:r(c.line,n)}})});
